<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>CrewAI Chat PT Air</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #2a2a2a;
            padding: 15px 20px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 18px; color: #4fc3f7; }
        .session-info { font-size: 12px; color: #888; }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .message {
            display: flex;
            gap: 10px;
            max-width: 85%;
        }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .message.user .message-avatar { background: #4fc3f7; color: #fff; }
        .message.assistant .message-avatar { background: #7e57c2; color: #fff; }
        .message-content {
            background: #2a2a2a;
            padding: 12px 16px;
            border-radius: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }
        .message.user .message-content { background: #1e3a5f; }
        .message.assistant .message-content {
            background: #2d2a3d;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .message-content strong { color: #4fc3f7; font-weight: 600; }
        .message-content code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #a5d6a7;
        }
        .message-content pre {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }
        .message-content pre code {
            background: none;
            padding: 0;
            color: #a5d6a7;
        }
        .message-content ul, .message-content ol {
            margin-left: 20px;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        .message-content li {
            margin: 4px 0;
        }
        .message-content p {
            margin: 8px 0;
        }
        .message-content h1, .message-content h2, .message-content h3 {
            color: #4fc3f7;
            margin-top: 12px;
            margin-bottom: 8px;
        }
        .input-container {
            background: #2a2a2a;
            padding: 15px 20px;
            border-top: 1px solid #3a3a3a;
            display: flex;
            gap: 10px;
        }
        .input-container input {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
            padding: 12px 16px;
            border-radius: 24px;
        }
        .input-container button {
            background: #4fc3f7;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            cursor: pointer;
        }
        .input-container button:disabled {
            background: #555;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ¤– CrewAI Chat PT Air - <span id="modelName">Claude Sonnet 4</span></h1>
        <span class="session-info" id="sessionInfo">Ready</span>
    </div>
    <div class="chat-container" id="chatContainer"></div>
    <div class="input-container">
        <input id="messageInput" type="text" placeholder="Type your message...">
        <button id="sendBtn">Send</button>
    </div>
    <script>
        var sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        var userId = 'user-' + Math.random().toString(36).substr(2, 9);
        var isProcessing = false;
        var modelMasked = false;  // Default: show model name (mask off)

        document.getElementById('sessionInfo').textContent = 'Session: ' + sessionId.substr(0, 20) + '...';

        function sendMessage() {
            var inp = document.getElementById('messageInput');
            var msg = inp.value.trim();
            if (!msg || isProcessing) return;

            // Check for mask commands - HANDLE LOCALLY, DON'T SEND TO SERVER
            if (msg.toLowerCase() === 'mask on') {
                modelMasked = true;
                document.getElementById('modelName').style.display = 'none';
                inp.value = '';
                // Don't add message to chat
                return;
            }
            if (msg.toLowerCase() === 'mask off') {
                modelMasked = false;
                document.getElementById('modelName').style.display = 'inline';
                inp.value = '';
                // Don't add message to chat
                return;
            }

            // Regular message - send to server
            isProcessing = true;
            inp.value = '';
            document.getElementById('sendBtn').disabled = true;

            addMessage('user', msg);

            fetch('/chat/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    message: msg,
                    session_id: sessionId,
                    user_id: userId
                })
            })
            .then(function(response) {
                if (!response.ok) throw new Error('HTTP ' + response.status);
                return response.body.getReader();
            })
            .then(function(reader) {
                var decoder = new TextDecoder();
                var fullResponse = '';
                var messageDiv = null;

                function read() {
                    reader.read().then(function(result) {
                        if (result.done) {
                            isProcessing = false;
                            document.getElementById('sendBtn').disabled = false;
                            return;
                        }
                        var chunk = decoder.decode(result.value);
                        var lines = chunk.split('\n');
                        for (var i = 0; i < lines.length; i++) {
                            if (lines[i].startsWith('data: ')) {
                                var data = JSON.parse(lines[i].slice(6));
                                if (data.model) {
                                    document.getElementById('modelName').textContent = data.model;
                                }
                                if (data.token) {
                                    fullResponse += data.token;
                                    if (!messageDiv) {
                                        messageDiv = addMessage('assistant', '');
                                    }
                                    var formatted = formatMarkdown(fullResponse);
                                    messageDiv.querySelector('.message-content').innerHTML = formatted;
                                    scrollToBottom();
                                }
                                if (data.error) {
                                    if (!messageDiv) {
                                        messageDiv = addMessage('assistant', 'Error: ' + data.error);
                                    }
                                    isProcessing = false;
                                    document.getElementById('sendBtn').disabled = false;
                                }
                            }
                        }
                        read();
                    });
                }
                read();
            })
            .catch(function(error) {
                addMessage('assistant', 'Error: ' + error.message);
                isProcessing = false;
                document.getElementById('sendBtn').disabled = false;
            });
        }

        document.getElementById('sendBtn').onclick = sendMessage;

        document.getElementById('messageInput').onkeydown = function(e) {
            if (e.key === 'Enter' && !isProcessing) {
                e.preventDefault();
                sendMessage();
            }
        };

        function addMessage(role, content) {
            var chatContainer = document.getElementById('chatContainer');
            var messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + role;
            var avatar = role === 'user' ? 'U' : 'AI';
            messageDiv.innerHTML = '<div class="message-avatar">' + avatar + '</div><div class="message-content">' + content + '</div>';
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
            return messageDiv;
        }

        function scrollToBottom() {
            var container = document.getElementById('chatContainer');
            container.scrollTop = container.scrollHeight;
        }

        function formatMarkdown(text) {
            // Escape HTML first to prevent injection
            var escapeHtml = function(unsafe) {
                return unsafe
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            };

            text = escapeHtml(text);

            // Code blocks (```code```) - must be before inline code
            text = text.replace(/```(\w+)?\n?([\s\S]*?)```/g, function(match, lang, code) {
                return '<pre><code>' + code.trim() + '</code></pre>';
            });

            // Inline code (`code`)
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Bold (**text**)
            text = text.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');

            // Headers
            text = text.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            text = text.replace(/^# (.+)$/gm, '<h1>$1</h1>');

            // Unordered lists - handle more carefully
            var lines = text.split('\n');
            var inList = false;
            var result = [];

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                if (line.match(/^[\-\*] (.+)$/)) {
                    if (!inList) {
                        result.push('<ul>');
                        inList = true;
                    }
                    result.push('<li>' + line.replace(/^[\-\*] /, '') + '</li>');
                } else if (line.match(/^\d+\. (.+)$/)) {
                    if (!inList) {
                        result.push('<ol>');
                        inList = true;
                    }
                    result.push('<li>' + line.replace(/^\d+\. /, '') + '</li>');
                } else {
                    if (inList) {
                        result.push(result.indexOf('<ul>') > result.indexOf('<ol>') ? '</ul>' : '</ol>');
                        inList = false;
                    }
                    result.push(line);
                }
            }
            if (inList) {
                result.push('</ul>');
            }

            text = result.join('\n');

            // Line breaks
            text = text.replace(/\n/g, '<br>');

            // Clean up multiple consecutive <br> tags
            text = text.replace(/(<br>){3,}/g, '<br><br>');

            return text;
        }
    </script>
</body>
</html>
